# KFX フォーマット仕様（推定）

本書は calibre 用 KFX Input プラグインのソースコードを解析し、KFX コンテナの内部構造を推定した仕様書である。Kindle 公式仕様ではなく、プラグインの挙動から得られた情報に基づいている点に留意されたい。

## 1. コンテナ全体構造

KFX ファイルは `"CONT"` という 4 バイトのシグネチャを持つコンテナであり、既定バージョンは 2（互換バージョン 1〜2）である。ヘッダー最小長は 18 バイト、推奨チャンクサイズは 4096 バイトで、コンテナの最大長は 16 MiB と定義されている。

- シグネチャ: `"CONT"`
- バージョン: 2（許容: 1, 2）
- ヘッダー最小長: 18 バイト
- 最大コンテナサイズ: 16 MiB
- 既定圧縮方式 ID: 0（非圧縮）
- 既定 DRM スキーム ID: 0（DRM 無し）

### 1.1 ヘッダーとコンテナ情報

ヘッダー先頭にはシグネチャ・バージョン・ヘッダー長に続き、Ion で表現されたコンテナ情報へのオフセットと長さが格納される。コンテナ情報は以下の Ion 構造体で、いずれもシンボル ID が数値化された名前で管理される。

| シンボル ID | 意味 | 備考 |
| --- | --- | --- |
| `$409` | コンテナ ID（ACR） | kfxgen_acr と照合される |
| `$410` | 圧縮方式 ID | 既定値 0。異なる場合は警告 |
| `$411` | DRM スキーム ID | 既定値 0 |
| `$412` | チャンクサイズ | 既定値 4096 |
| `$413`/`$414` | エンティティ索引テーブルの開始位置とサイズ | テーブル内の各行はエンティティ ID、型 ID、データのオフセット・サイズを保持 |
| `$415`/`$416` | 文書シンボル表の位置と長さ | 存在する場合、Ion の `$ion_symbol_table` 注釈で格納 |
| `$594`/`$595` | フォーマット機能ブロックの位置と長さ | コンテナバージョン > 1 の場合に使用 |

コンテナ情報 Ion から未消費の値が残った場合は異常とみなされる。

### 1.2 ドキュメントシンボル表

`$415/$416` が示す領域には Ion 注釈 `$ion_symbol_table` を持つシンボル表が格納される。プラグインは読み込み時に Amazon のシステムシンボル表を差し引き、内部シンボルテーブルへ登録する。シリアライズ時は逆に再加算してエクスポートする。

### 1.3 フォーマット機能ブロック

バージョン 2 以降のコンテナでは、任意で `$593` 注釈を持つフォーマット機能 Ion を格納できる。機能ブロックはシンボルテーブルのローカル ID が 595 より大きい場合にのみ書き戻される。

### 1.4 kfxgen 情報ストリーム

ヘッダーの末尾から本体データまでの領域には、JSON 風テキストが挿入されており、アプリケーションバージョン・パッケージバージョン・ペイロード SHA-1・ACR を記録する。テキストは `key:`/`value:` 形式で格納されるため、解析時に JSON へ整形して扱う。

## 2. コンテナエンティティ

各フラグメントはエンティティとして格納される。エンティティは `"ENTY"` シグネチャとバージョン 1 を持つヘッダーを備え、先頭のヘッダーブロックは Ion で圧縮方式と DRM スキーム（いずれも既定値 0）を記録する。ヘッダー後続のデータ領域には実際のフラグメント本体が格納される。

- シグネチャ: `"ENTY"`
- バージョン: 1
- ヘッダー最小長: 10 バイト
- ヘッダー Ion: `$410`（圧縮）・`$411`（DRM）

フラグメントの型シンボルが `$418` または `$417` の場合はバイナリ BLOB として格納され、それ以外は IonBinary で Ion 値として解釈される。エンティティには ID（`$348` 注釈で匿名 ID を示す場合あり）とフラグメント型のシンボル ID が添付され、コンテナ情報のエンティティ一覧 (`$181`) にも `[type_id, id_id]` の並びで登録される。

## 3. フラグメント体系

KFX は Ion 注釈を利用して「フラグメント」と呼ばれる論理単位を管理する。プラグインは既知のフラグメント型とその並び順、必須／任意要素を以下のように定義している。

### 3.1 フラグメント型の優先順序

並べ替えや比較時に利用される優先順序は次の通り。

```
$ion_symbol_table, $270, $593, $585, $490, $258, $538, $389, $390,
$260, $259, $608, $145, $756, $692, $157,
$391, $266, $394,
$264, $265, $550, $609, $621, $611, $610,
$597, $267, $387,
$395,
$262, $164,
$418, $417,
$419
```

### 3.2 ルートおよび単一出現フラグメント

ルートフラグメント（コンテナ直下に現れる）の型と、その中で単一出現が期待されるものは以下の通りである。

| カテゴリー | フラグメント型 |
| --- | --- |
| ルート | `$ion_symbol_table`, `$270`, `$490`, `$389`, `$419`, `$585`, `$538`, `$262`, `$593`, `$550`, `$258`, `$265`, `$264`, `$395`, `$390`, `$621`, `$611` |
| 単一出現 | 上記ルート集合から `$270`, `$262`, `$593` を除いたもの（1 つのみ存在が期待される） |

### 3.3 必須および許容フラグメント

| 種別 | フラグメント型 |
| --- | --- |
| 必須 | `$ion_symbol_table`, `$270`, `$490`, `$389`, `$419`, `$538`, `$550`, `$258`, `$265`, `$264`, `$611` |
| 任意 | `$266`, `$597`, `$418`, `$417`, `$394`, `$145`, `$585`, `$610`, `$164`, `$262`, `$593`, `$391`, `$692`, `$387`, `$395`, `$756`, `$260`, `$267`, `$390`, `$609`, `$259`, `$608`, `$157`, `$621` |

### 3.4 フラグメント ID の決定

特定のフラグメント型は内部フィールド値で識別子（`fid`）を導出する。例えば `$266` はフィールド `$180`、`$145` は `name` フィールドを ID として用いる。ID 判定に利用されるフィールド一覧を次表に示す。

| フラグメント型 | 照キー |
| --- | --- |
| `$266` | `$180` |
| `$597` | `$174`, `$598` |
| `$418`/`$417` | `$165` |
| `$394` | `$240` |
| `$145` | `name` |
| `$164` | `$175` |
| `$391` | `$239` |
| `$692` | `name` |
| `$387` | `$174` |
| `$756` | `$757` |
| `$260`/`$267`/`$609` | `$174` |
| `$259` | `$176` |
| `$608` | `$598` |
| `$157` | `$173` |
| `$610` | `$602` |

### 3.5 フラグメント間参照

多くの Ion 構造は他フラグメントを参照するシンボルフィールドを持つ。プラグインが把握している代表的な参照先は以下の通り。

- `$749` → `$259`（目次リンクなど）
- `$165`/`$636` → `$417`（リソース参照）
- `$479`/`$245`/`$167`/`$175`/`$528`/`$214`/`$635` → `$164`
- `$392` → `$391`、`$174`/`$170` → `$260`、`$176` → `$259`

辞書や入れ子構造向けの特別ルール（`$391`→`$394` など）も定義されている。

## 4. メタデータ

メタデータは主に `$490` フラグメントの `$491` 構造、および `$258` フラグメントのキー/値マップで管理される。既知のメタデータキーとシンボル ID の対応は次の通り。

| 人間可読キー | シンボル ID |
| --- | --- |
| ASIN | `$224` |
| asset_id | `$466` |
| author | `$222` |
| cde_content_type | `$251` |
| cover_image | `$424` |
| description | `$154` |
| language | `$10` |
| orientation | `$215` |
| publisher | `$232` |
| reading_orders | `$169` |
| support_landscape | `$218` |
| support_portrait | `$217` |
| title | `$153` |

`$490` 内の `kindle_title_metadata` コレクションでは、キー `author`／`title`／`ASIN` 等を個別のレコードとして保持する。`$258` には冗長な情報が残っていることがあり、`author` フィールドは複数著者を文字列から分割して構築する処理が含まれている。

メタデータ書き込み時には既存値の差し替えやカバー画像の再エンコード（JPEG 形式の検証）を行い、必要に応じて ASIN を自動生成するロジックも存在する。

## 5. データ型と Ion 表現

KFX の論理データは Amazon Ion 形式で表現される。Ion は JSON に類似した構造化バイナリで、シンボルテーブルによる識別子管理を行う。

- Ion の基本型は bool、decimal、float、int、list、null、string 等。
- `IonAnnotation` は Ion 値に対し 1 つ以上のシンボル注釈を付与する。フラグメントは `fid` と `ftype` の 2 注釈を持つ。
- バイナリデータは `IonBLOB` として扱われ、ASCII で解釈できない場合は大型データとして判定される。
- `IonStruct` は順序付きマップであり、偶数個の引数を `キー, 値` のペアとして受け取る。
- `IonSymbol` はシンボルテーブル内の文字列を表し、ASCII 範囲外はバッククォート表記で表示される。

## 6. フォーマット識別と派生形式

コンテナ内に含まれるフラグメント型の ID 番号を調べ、`$259`/`$260`/`$538` を含む場合は「KFX main」、`$258`/`$419`/`$490`/`$585` などメタデータ主体の場合は「KFX metadata」、`$417` のみの場合は「KFX attachable」と判定する。

DRM 付き Ion ブロックは `"\xeaDRMION\xee"` で始まることがあるが、既定状態では DRM スキーム 0 が想定される。

## 7. 画像とリソース

画像リソースはチェック対象フォーマット（BMP, GIF, JPEG, PNG, SVG, TIFF, WEBP 等）と未チェックフォーマット（JXR, KVG）に分類される。固定レイアウトの画像形式は `$286` などのシンボルで示される。リソース参照は `$165`（および `$636`）のフィールドから `$417` フラグメントを指す。

## 8. セクションデータと期待される注釈

テキストやレイアウト断片（`$387`, `$260`, `$267`, `$609`）はセクションデータとして扱われ、特定の注釈組み合わせ（例: `$389::$247::$393`）が期待される。辞書コンテンツではさらに `$260::$141::$608` のような注釈が想定される。

## 9. シンボル分類

プラグインはシンボルを *common*（共通）, *dictionary*（辞書用）, *original*（元書籍由来）, *base64*, *short*, *shared*, *unknown* といったカテゴリーに分類し、解析時の診断情報に用いている。

## 10. 注意事項

- 本仕様はプラグイン実装に基づく推定であり、Amazon が公式に公開する仕様とは異なる可能性がある。
- DRM が適用されたコンテナでは Ion データが暗号化されるため、本仕様のままでは解読できない。
- Ion シンボル ID（`$xxx`）はシンボルテーブルに依存するため、別のコンテナでは異なる名称が割り当てられる可能性がある。

*出典: calibre KFX Input プラグイン（John Howell, 2016-2025）*
